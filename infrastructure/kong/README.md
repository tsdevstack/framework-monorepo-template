# Kong Gateway with OIDC Plugin

This directory contains the Dockerfile for building a custom Kong Gateway image with OIDC/JWT authentication support.

## Overview

The custom Kong image extends the official `kong:3.8` image and adds:
- **lua-resty-openidc** (v1.7.6): OIDC client library for Lua
- **kong-oidc-v3**: Kong 3.x compatible OIDC plugin for JWT validation via JWKS

## Why Manual Installation?

As of Kong 3.8, there is a known issue with the luarocks package manager where the manifest becomes too large ("main function has more than 65536 constants"). This prevents standard plugin installation via `luarocks install`.

**Solution**: We manually clone the plugin repositories from GitHub and copy the Lua files directly to Kong's Lua path. This approach:
- Works reliably with Kong 3.8
- Pins specific versions (v1.7.6 for openidc)
- No dependency on luarocks manifest
- Produces a working Kong image with OIDC support

## Building the Image

The image is built automatically by `docker compose up`. You can also build it manually:

```bash
docker build -t kong-custom:latest ./infrastructure/kong
```

## Plugin Configuration

The OIDC plugin is configured in `kong.yml` (generated by `npx tsdevstack generate-kong`). Configuration includes:
- **discovery_endpoint**: OIDC discovery URL
- **issuer**: JWT issuer URL
- **token_header**: Header containing the JWT (typically `authorization`)
- **claims_to_forward**: JWT claims to forward as HTTP headers to backend services

## Future Considerations

If the luarocks manifest issue is resolved in future Kong versions, we can revert to:
```dockerfile
RUN luarocks install kong-oidc-v3
```

## References

- [kong-oidc-v3 GitHub](https://github.com/Gate1106/kong-oidc-v3) - Kong 3.x compatible OIDC plugin
- [lua-resty-openidc GitHub](https://github.com/zmartzone/lua-resty-openidc) - OpenID Connect library for Nginx/OpenResty
- [Kong Plugin Development Guide](https://docs.konghq.com/gateway/latest/plugin-development/)
